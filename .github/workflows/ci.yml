name: CI

on:
  push:          # å¯¹ main / master ä»»ä½• push
    branches: [ main, master ]
  pull_request:  # PR ç›®æ ‡ä¸º main / master
    branches: [ main, master ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # ---------- â‘  æ£€æµ‹æ”¹åŠ¨ ----------
    - name: Detect modified tools
      id: filter
      uses: dorny/paths-filter@v3
      with:
        token: ${{ github.token }}
        list-files: shell
        filters: |
          tools-changed:
            - added|modified: 'servers/*/**'

    # ---------- â‘¡ å¦‚æœæ²¡æœ‰ tool æ”¹åŠ¨åˆ™è·³è¿‡ ----------
    - name: Skip when nothing to build
      if: steps.filter.outputs.tools-changed == 'false'
      run: echo "No tools changed â€“ skipping build & test."

    # ---------- â‘¢ å®‰è£… Python / ä¾èµ– ----------
    - name: Set up Python 3.12
      if: steps.filter.outputs.tools-changed == 'true'
      uses: actions/setup-python@v4
      with: {python-version: '3.12'}

    - name: Install project dependencies
      if: steps.filter.outputs.tools-changed == 'true'
      run: |
        python -m pip install -U pip uv
        pip install flake8

    # ---------- â‘£ æ„å»º + è½»é‡æµ‹è¯•æ”¹åŠ¨çš„å·¥å…· ----------
    - name: Build & test changed tools
      if: steps.filter.outputs.tools-changed == 'true'
      run: |
        declare -A changed=()
        for f in ${{ steps.filter.outputs.tools-changed_files }}; do
          tool=$(echo "$f" | cut -d/ -f2)
          changed["$tool"]=1
        done

        echo "Tools to build: ${!changed[@]}"
        for t in "${!changed[@]}"; do
          echo "ğŸ”¨ Building $t"
          python hack/build_docker.py "$t"
          python hack/gen_k8s.py "$t" 50001
        done