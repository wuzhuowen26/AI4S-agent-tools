name: Release

on:
  push:
    tags: [ 'v*' ]     # ä¾‹å¦‚ v1.2.3

permissions:
  contents: read       # è¯»ä»“åº“
  packages: write      # æ¨ GHCR

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with: {fetch-depth: 0}   # éœ€è¦å®Œæ•´ git å†å²

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # ---------- â‘  æ‰¾ä¸Šä¸€ä¸ª tag ----------
    - id: prev
      run: |
        last=$(git describe --tags --abbrev=0 $(git rev-parse HEAD^) 2>/dev/null || echo '')
        echo "last=$last" >> $GITHUB_OUTPUT

    # ---------- â‘¡ diff å‡ºã€Œæ–°å¢å·¥å…·ç›®å½•ã€ ----------
    - id: new
      run: |
        if [[ -z "${{ steps.prev.outputs.last }}" ]]; then
          echo "dirs=$(ls -1 -d servers/* | xargs -n1 basename | tr '\n' ' ')" >> $GITHUB_OUTPUT
        else
          diff=$(git diff --name-status ${{ steps.prev.outputs.last }} HEAD -- servers/ | awk '$1=="A"{print $2}' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          echo "dirs=$diff" >> $GITHUB_OUTPUT
        fi

    - name: Skip when no new tools
      if: steps.new.outputs.dirs == ''
      run: echo "No NEW tool directories â€“ skipping release."

    # ---------- â‘¢ æ„å»º & æ¨é€ ----------
    - name: Build + push only NEW tools
      if: steps.new.outputs.dirs != ''
      env:
        TAG: ${{ github.ref_name }}   # vX.Y.Z
      run: |
        for tool in ${{ steps.new.outputs.dirs }}; do
          echo "ğŸš€ Building $tool"
          python hack/build_docker.py "$tool"
          python hack/gen_k8s.py "$tool" 50001

          dst="ghcr.io/${{ github.repository }}/$tool:${TAG}"
          docker tag "${tool}:latest" "$dst"
          docker push "$dst"
        done

    # ---------- â‘£ åˆ›å»º GitHub Release ----------
    - name: Create GitHub Release
      if: steps.new.outputs.dirs != ''
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true